<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>サンプルプロジェクト</title>
	<link rel="shortcut icon" href="TemplateData/favicon.ico">
	<script src="https://unpkg.com/blockly/blockly.min.js"></script>
	<script src="acorn_interpreter.js"></script>
	<script src="myblock.js"></script>
</head>

<body>
	<div class="flex">
		<div id="blocklyDiv" style="width:100%; height:300px;"></div> <!-- ワークスペースを用意 -->
		<xml id="toolbox" style="display: none">
			<block type="move_left"></block>
			<block type="move_right"></block>
			<block type="jump"></block>
			<block type="attack"></block>
			<block type="attackif"></block>
			<block type="enemypos"></block>
			<block type="check_point"></block>
			
			<!--<block type="enemy"></block>-->
			<block type="get_left"></block>
			<!--<block type="check_emypos"></block>-->

			<block type="controls_if"></block>
			<block type="controls_repeat_ext"></block>
			<block type="math_number"></block>
			<block type="math_arithmetic"></block>
		</xml>
		<canvas id="unity-canvas" class="border border-success" 
		style="width: 100%; height: 640px; background: #FFFFFF"></canvas>
	</div>
	<script src="Build/Build.loader.js"></script>
	<script>
		var unityInstance = null;
		createUnityInstance(document.querySelector("#unity-canvas"), {
		dataUrl: "Build/Build.data",
		frameworkUrl: "Build/Build.framework.js",
		codeUrl: "Build/Build.wasm",
		streamingAssetsUrl: "StreamingAssets",
		companyName: "DefaultCompany",
		productName: "New Unity Project",
		productVersion: "0.1",
		}).then(x => unityInstance = x);
	</script>
	<script>
		let workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox'),
		maxBlocks:10, maxInstances:{'jump':2}});
		let target_object;
		let playerx;
		let playery;
		let data_json;

		/*document.addEventListener('click', function (e) {
			if (e.target.id == "unity-canvas") {
				// Clicked on canvas 
				unityInstance.SendMessage("Button", "FocusCanvas", "1");
			} else {
				// Clicked outside of canvas 
				unityInstance.SendMessage("Button", "FocusCanvas", "0");
			}
		});*/
	
		const initFunc = function (interpreter, scope) {
			let move_left_wrapper = function () {
				return move_left_function();
			}; 
			let move_right_wrapper = function () {
				return move_right_function();
			};
			let jump_wrapper = function () {
				return jump_function();
			};
			let attack_wrapper = function () {
				return attack_function();
			};
			let check_wrapper = function (direction, object) {
				return check_point_function(direction, object);
			};
			let attackif_wrapper = function () {
				return attackif_function();
			};
			/*let enemypos_wrapper = function () {
				return enemypos_function();
			};*/
			

			interpreter.setProperty(scope, 'moveleft', interpreter.createNativeFunction(move_left_wrapper));/*2*/
			interpreter.setProperty(scope, 'moveright', interpreter.createNativeFunction(move_right_wrapper));
			interpreter.setProperty(scope, 'jump', interpreter.createNativeFunction(jump_wrapper));
			interpreter.setProperty(scope, 'attack', interpreter.createNativeFunction(attack_wrapper));
			interpreter.setProperty(scope, 'attackif', interpreter.createNativeFunction(attackif_wrapper));
			//interpreter.setProperty(scope, 'enemypos', interpreter.createNativeFunction(enemypos_wrapper));
			
			interpreter.setProperty(scope, 'check_point', interpreter.createNativeFunction(check_wrapper));
	
		}


		function move_left_function() {
			unityInstance.SendMessage("Player", "MoveLeft");
		}
		function move_right_function() {
			unityInstance.SendMessage("Player", "MoveRight");
		}
		function jump_function(){
			unityInstance.SendMessage("Player", "Jump");
		}
		function attack_function(){
			unityInstance.SendMessage("Player", "Attack");
		}
		function attackif_function(){
			unityInstance.SendMessage("Player", "Attackif");
		}
		/*function enemypos_function(){
			unityInstance.SendMessage("Player", "Enemypos");
		}*/
		

		function check_point_function(direction, object){			
			let check_point;
			switch(direction){
				case 'left':
					check_point = {x:playerx - 1, y:playery};
					break;
				case 'right':
					check_point = {x:playerx + 1, y: playery};
					break;
			}
			if(data_json.EnemyData.find(object => object.x == check_point.x || object.y == check_point.y)){
				console.log("pass1");
				return true;
			}else{
				return false;
			}
		}
	</script>
	
	<style>
		.flex {
			display: block;
		}

	</style>
</body>
</html>
